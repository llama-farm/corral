// {{APP_NAME}} — Corral Auth + Billing Setup
// Generated by `corral init` — edit freely
//
// IMPORTANT: This file runs on the SERVER only.
// The database is auto-bootstrapped on first run — no manual migration needed.

import { betterAuth } from "better-auth";
import { admin } from "better-auth/plugins";
import Database from "better-sqlite3";
import path from "path";

const dbPath = path.resolve(process.cwd(), "corral.db");

// Auto-bootstrap: create database and tables if they don't exist.
// Fully idempotent — safe to run on every server start.
function bootstrapDatabase(filePath: string) {
  const db = new Database(filePath);
  db.pragma("journal_mode = WAL");

  db.exec(`
    CREATE TABLE IF NOT EXISTS "user" (
      id TEXT PRIMARY KEY,
      name TEXT NOT NULL,
      email TEXT NOT NULL UNIQUE,
      emailVerified INTEGER NOT NULL DEFAULT 0,
      image TEXT,
      createdAt TEXT NOT NULL DEFAULT (datetime('now')),
      updatedAt TEXT NOT NULL DEFAULT (datetime('now')),
      role TEXT DEFAULT 'user',
      banned INTEGER DEFAULT 0,
      banReason TEXT,
      banExpires TEXT
    );
    CREATE TABLE IF NOT EXISTS "session" (
      id TEXT PRIMARY KEY,
      userId TEXT NOT NULL REFERENCES "user"(id) ON DELETE CASCADE,
      token TEXT NOT NULL UNIQUE,
      expiresAt TEXT NOT NULL,
      ipAddress TEXT,
      userAgent TEXT,
      createdAt TEXT NOT NULL DEFAULT (datetime('now')),
      updatedAt TEXT NOT NULL DEFAULT (datetime('now'))
    );
    CREATE TABLE IF NOT EXISTS "account" (
      id TEXT PRIMARY KEY,
      userId TEXT NOT NULL REFERENCES "user"(id) ON DELETE CASCADE,
      accountId TEXT NOT NULL,
      providerId TEXT NOT NULL,
      accessToken TEXT,
      refreshToken TEXT,
      accessTokenExpiresAt TEXT,
      refreshTokenExpiresAt TEXT,
      scope TEXT,
      password TEXT,
      createdAt TEXT NOT NULL DEFAULT (datetime('now')),
      updatedAt TEXT NOT NULL DEFAULT (datetime('now'))
    );
    CREATE TABLE IF NOT EXISTS "verification" (
      id TEXT PRIMARY KEY,
      identifier TEXT NOT NULL,
      value TEXT NOT NULL,
      expiresAt TEXT NOT NULL,
      createdAt TEXT NOT NULL DEFAULT (datetime('now')),
      updatedAt TEXT NOT NULL DEFAULT (datetime('now'))
    );
    CREATE INDEX IF NOT EXISTS idx_session_token ON "session"(token);
    CREATE INDEX IF NOT EXISTS idx_session_userId ON "session"(userId);
    CREATE INDEX IF NOT EXISTS idx_account_userId ON "account"(userId);
    CREATE INDEX IF NOT EXISTS idx_user_email ON "user"(email);
  `);

  return db;
}

const db = bootstrapDatabase(dbPath);

export const auth = betterAuth({
  // LEARNING #1: Pass raw Database instance directly.
  // Do NOT use { db, type: "sqlite" } — causes "selectFrom is not a function".
  database: db,

  // Base URL and path — must match your route handler location
  baseURL: process.env.BETTER_AUTH_URL || "http://localhost:{{PORT}}",
  basePath: "/api/auth",

  // Secret for signing tokens — MUST be set in .env
  secret: process.env.BETTER_AUTH_SECRET,

  // Email + password authentication
  emailAndPassword: {
    enabled: true,
  },

  // Custom user fields — plan for gating
  user: {
    additionalFields: {
      plan: {
        type: "string" as const,
        defaultValue: "free",
      },
    },
  },

  // Plugins
  plugins: [
    admin(),  // Admin dashboard, user management
  ],

  // Session config
  session: {
    expiresIn: 60 * 60 * 24 * 30, // 30 days
  },

  // LEARNING #5: trustedOrigins required for sign-out CSRF protection.
  // Include all origins that will make auth requests.
  trustedOrigins: (process.env.TRUSTED_ORIGINS || "http://localhost:3000,http://localhost:5173")
    .split(",")
    .flatMap(o => [o.trim(), o.trim().replace("localhost", "127.0.0.1")]),
});

export type Session = typeof auth.$Infer.Session;
