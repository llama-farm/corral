// {{APP_NAME}} â€” Corral Auth + Billing Setup
// Generated by `corral init` â€” edit freely
//
// IMPORTANT: This file runs on the SERVER only.
// The database is auto-bootstrapped on first run â€” no manual migration needed.
//
// ESM-compatible: uses dynamic import() for the database driver.

import { betterAuth } from "better-auth";
import { admin } from "better-auth/plugins";

// â”€â”€â”€ Database Setup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Dynamic import keeps this file ESM-safe and allows swapping drivers.
// To use PostgreSQL, Turso, etc., change the adapter below and install
// the corresponding package. See CORRAL.md for details.

async function createDatabase() {
  const { default: Database } = await import("better-sqlite3");
  const dbPath = new URL("./corral.db", import.meta.url).pathname;
  return new Database(dbPath);
}

async function bootstrapDatabase(db: any) {
  db.pragma("journal_mode = WAL");

  db.exec(`
    CREATE TABLE IF NOT EXISTS "user" (
      id TEXT PRIMARY KEY,
      name TEXT NOT NULL,
      email TEXT NOT NULL UNIQUE,
      emailVerified INTEGER NOT NULL DEFAULT 0,
      image TEXT,
      plan TEXT NOT NULL DEFAULT 'free',
      createdAt TEXT NOT NULL DEFAULT (datetime('now')),
      updatedAt TEXT NOT NULL DEFAULT (datetime('now')),
      role TEXT DEFAULT 'user',
      banned INTEGER DEFAULT 0,
      banReason TEXT,
      banExpires TEXT
    );
    CREATE TABLE IF NOT EXISTS "session" (
      id TEXT PRIMARY KEY,
      userId TEXT NOT NULL REFERENCES "user"(id) ON DELETE CASCADE,
      token TEXT NOT NULL UNIQUE,
      expiresAt TEXT NOT NULL,
      ipAddress TEXT,
      userAgent TEXT,
      createdAt TEXT NOT NULL DEFAULT (datetime('now')),
      updatedAt TEXT NOT NULL DEFAULT (datetime('now'))
    );
    CREATE TABLE IF NOT EXISTS "account" (
      id TEXT PRIMARY KEY,
      userId TEXT NOT NULL REFERENCES "user"(id) ON DELETE CASCADE,
      accountId TEXT NOT NULL,
      providerId TEXT NOT NULL,
      accessToken TEXT,
      refreshToken TEXT,
      accessTokenExpiresAt TEXT,
      refreshTokenExpiresAt TEXT,
      scope TEXT,
      password TEXT,
      createdAt TEXT NOT NULL DEFAULT (datetime('now')),
      updatedAt TEXT NOT NULL DEFAULT (datetime('now'))
    );
    CREATE TABLE IF NOT EXISTS "verification" (
      id TEXT PRIMARY KEY,
      identifier TEXT NOT NULL,
      value TEXT NOT NULL,
      expiresAt TEXT NOT NULL,
      createdAt TEXT NOT NULL DEFAULT (datetime('now')),
      updatedAt TEXT NOT NULL DEFAULT (datetime('now'))
    );
    CREATE INDEX IF NOT EXISTS idx_session_token ON "session"(token);
    CREATE INDEX IF NOT EXISTS idx_session_userId ON "session"(userId);
    CREATE INDEX IF NOT EXISTS idx_account_userId ON "account"(userId);
    CREATE INDEX IF NOT EXISTS idx_user_email ON "user"(email);
  `);
}

// Initialize DB and auth
const db = await createDatabase();
await bootstrapDatabase(db);

export const auth = betterAuth({
  database: db,
  baseURL: process.env.BETTER_AUTH_URL || "http://localhost:{{PORT}}",
  basePath: "/api/auth",
  secret: process.env.BETTER_AUTH_SECRET,
  emailAndPassword: {
    enabled: true,
  },
  user: {
    additionalFields: {
      plan: {
        type: "string" as const,
        defaultValue: "free",
      },
    },
  },
  plugins: [
    admin(),
  ],
  session: {
    expiresIn: 60 * 60 * 24 * 30, // 30 days
  },
  trustedOrigins: (() => {
    const frontendPort = process.env.FRONTEND_PORT || process.env.PORT || "{{PORT}}";
    const base = [
      `http://localhost:${frontendPort}`,
      `http://127.0.0.1:${frontendPort}`,
      process.env.APP_URL,
    ];
    const extra = (process.env.TRUSTED_ORIGINS || "")
      .split(",").map(o => o.trim()).filter(Boolean);
    return [...base, ...extra].filter(Boolean) as string[];
  })(),
});

export type Session = typeof auth.$Infer.Session;

// â”€â”€â”€ Auto-seed admin user on first boot â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(async () => {
  try {
    const existing = db.prepare('SELECT id FROM "user" WHERE role = ?').get('admin');
    if (existing) return;

    const seedEmail = process.env.SEED_ADMIN_EMAIL || "";
    const seedPassword = process.env.SEED_ADMIN_PASSWORD || "";
    const seedName = process.env.SEED_ADMIN_NAME || "Admin";
    const seedPlan = "{{DEFAULT_PAID_PLAN}}" || "free";

    if (!seedEmail || !seedPassword) return;

    const { createHash, scryptSync, randomBytes } = await import("node:crypto");
    const salt = randomBytes(16).toString("hex");
    const hash = scryptSync(seedPassword, salt, 64).toString("hex");
    const hashedPassword = `${salt}:${hash}`;

    const userId = createHash("sha256").update(seedEmail).digest("hex").slice(0, 32);
    const accountId = createHash("sha256").update(seedEmail + ":credential").digest("hex").slice(0, 32);
    const now = new Date().toISOString();

    db.prepare(`INSERT OR IGNORE INTO "user" (id, name, email, emailVerified, role, plan, createdAt, updatedAt) VALUES (?, ?, ?, 0, 'admin', ?, ?, ?)`)
      .run(userId, seedName, seedEmail, seedPlan, now, now);
    db.prepare(`INSERT OR IGNORE INTO "account" (id, userId, accountId, providerId, password, createdAt, updatedAt) VALUES (?, ?, ?, 'credential', ?, ?, ?)`)
      .run(accountId, userId, seedEmail, hashedPassword, now, now);

    console.log(`ðŸ¤  Corral: Seeded admin â†’ ${seedEmail} (role=admin, plan=${seedPlan})`);
  } catch (e) {
    // Silent â€” seeding is best-effort on startup
  }
})();
