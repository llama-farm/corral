// {{APP_NAME}} — Admin & Profile API Routes (generated by Corral)
// Mount in your Express server:
//   import corralAdminRoutes from './corral-admin-routes.js';
//   app.use('/api/corral', corralAdminRoutes);
//
// Or mount in Hono:
//   import { corralHonoRoutes } from './corral-admin-routes.js';
//   app.route('/api/corral', corralHonoRoutes);

import { Router } from "express";
import { auth } from "./corral.js";

const router = Router();

// ─── Auth helper ──────────────────────────────────────────────────
async function requireAuth(req: any, res: any, next: any) {
  const session = await auth.api.getSession({ headers: req.headers });
  if (!session?.user) {
    return res.status(401).json({ error: "Unauthorized" });
  }
  req.session = session;
  next();
}

async function requireAdmin(req: any, res: any, next: any) {
  const session = await auth.api.getSession({ headers: req.headers });
  if (!session?.user) {
    return res.status(401).json({ error: "Unauthorized" });
  }
  if (session.user.role !== "admin") {
    return res.status(403).json({ error: "Forbidden — admin only" });
  }
  req.session = session;
  next();
}

// ─── Profile ──────────────────────────────────────────────────────

// GET /api/corral/me — get current user + subscription
router.get("/me", requireAuth, async (req: any, res) => {
  const { user } = req.session;
  res.json({
    id: user.id,
    email: user.email,
    name: user.name,
    plan: user.plan ?? "free",
    role: user.role ?? "user",
    image: user.image,
  });
});

// POST /api/corral/upgrade — create Stripe checkout session
router.post("/upgrade", requireAuth, async (req: any, res) => {
  const { planId } = req.body;
  const { user } = req.session;

  if (!process.env.STRIPE_SECRET_KEY) {
    return res.status(503).json({ error: "Stripe not configured" });
  }

  try {
    const Stripe = (await import("stripe")).default;
    const stripe = new Stripe(process.env.STRIPE_SECRET_KEY!);

    const priceId = process.env[`STRIPE_PRICE_${(planId || "pro").toUpperCase()}`];
    if (!priceId) {
      return res.status(400).json({ error: `No price ID for plan: ${planId}` });
    }

    const session = await stripe.checkout.sessions.create({
      mode: "subscription",
      payment_method_types: ["card"],
      customer_email: user.email,
      line_items: [{ price: priceId, quantity: 1 }],
      success_url: `${process.env.APP_URL || "http://localhost:3000"}/profile?upgraded=1`,
      cancel_url: `${process.env.APP_URL || "http://localhost:3000"}/pricing`,
      metadata: { userId: user.id, planId: planId || "pro" },
    });

    res.json({ url: session.url });
  } catch (e: any) {
    res.status(500).json({ error: e.message });
  }
});

// POST /api/corral/billing-portal — Stripe customer portal
router.post("/billing-portal", requireAuth, async (req: any, res) => {
  const { user } = req.session;

  if (!process.env.STRIPE_SECRET_KEY) {
    return res.status(503).json({ error: "Stripe not configured" });
  }

  try {
    const Stripe = (await import("stripe")).default;
    const stripe = new Stripe(process.env.STRIPE_SECRET_KEY!);

    // Look up customer ID — stored in subscription table or user metadata
    const customers = await stripe.customers.list({ email: user.email, limit: 1 });
    if (customers.data.length === 0) {
      return res.status(400).json({ error: "No billing account found" });
    }

    const session = await stripe.billingPortal.sessions.create({
      customer: customers.data[0].id,
      return_url: `${process.env.APP_URL || "http://localhost:3000"}/profile`,
    });

    res.json({ url: session.url });
  } catch (e: any) {
    res.status(500).json({ error: e.message });
  }
});

// ─── Admin ────────────────────────────────────────────────────────

// GET /api/corral/admin/stats — quick dashboard numbers
router.get("/admin/stats", requireAdmin, async (req: any, res) => {
  try {
    const users = await auth.api.listUsers({ query: { limit: 1000 } });
    const allUsers = users?.users || [];
    const stats = {
      totalUsers: allUsers.length,
      byPlan: allUsers.reduce((acc: Record<string, number>, u: any) => {
        const plan = u.plan || "free";
        acc[plan] = (acc[plan] || 0) + 1;
        return acc;
      }, {}),
      admins: allUsers.filter((u: any) => u.role === "admin").length,
      banned: allUsers.filter((u: any) => u.banned).length,
    };
    res.json(stats);
  } catch (e: any) {
    res.status(500).json({ error: e.message });
  }
});

export default router;
