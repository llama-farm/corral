// {{APP_NAME}} â€” Admin Panel (generated by Corral)
// Full admin dashboard: user table with inline plan/role editing, plan config tab.
//
// Usage:
//   import { AdminPanel } from "./AdminPanel";
//   <AdminPanel onClose={() => navigate("/")} />
//
// Requires: auth-context.tsx, corral-styles.css

import { useState, useEffect, useCallback } from "react";
import { useAuth } from "{{AUTH_IMPORT_PATH}}";

// â”€â”€â”€ Types â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

interface UserRecord {
  id: string;
  name: string;
  email: string;
  role: string;
  plan: string;
  createdAt: string;
}

interface PlanConfig {
  name: string;
  display_name: string;
  price: number;
  interval?: string;
  trial_days?: number;
  features: string[];
  cta?: string;
}

interface Stats {
  total: number;
  admins: number;
  byPlan: Record<string, number>;
}

// â”€â”€â”€ Component â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

export function AdminPanel({ onClose }: { onClose: () => void }) {
  const { user } = useAuth();

  const [users, setUsers]           = useState<UserRecord[]>([]);
  const [plans, setPlans]           = useState<PlanConfig[]>([]);
  const [loading, setLoading]       = useState(true);
  const [tab, setTab]               = useState<"users" | "plans">("users");
  const [stats, setStats]           = useState<Stats>({ total: 0, admins: 0, byPlan: {} });
  const [editingUser, setEditingUser] = useState<string | null>(null);
  const [actionMsg, setActionMsg]   = useState<{ text: string; ok: boolean } | null>(null);
  const [searchQuery, setSearchQuery] = useState("");

  // New plan form state
  const [newPlan, setNewPlan] = useState({
    name: "", price: "", trial_days: "", features: "", cta: "",
  });

  // â”€â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  const flash = useCallback((text: string, ok = true) => {
    setActionMsg({ text, ok });
    setTimeout(() => setActionMsg(null), 2800);
  }, []);

  const loadData = useCallback(() => {
    setLoading(true);

    Promise.all([
      fetch("/api/admin/users", { credentials: "include" }).then((r) => r.ok ? r.json() : Promise.reject(new Error(r.statusText))),
      fetch("/api/admin/plans", { credentials: "include" }).then((r) => r.ok ? r.json() : Promise.reject(new Error(r.statusText))),
    ])
      .then(([userData, planData]) => {
        const u: UserRecord[] = userData.users || [];
        const byPlan: Record<string, number> = {};
        for (const row of u) {
          byPlan[row.plan] = (byPlan[row.plan] ?? 0) + 1;
        }
        setUsers(u);
        setStats({ total: u.length, admins: u.filter((x) => x.role === "admin").length, byPlan });
        setPlans(planData.plans || []);
      })
      .catch((e) => flash(e.message || "Failed to load data", false))
      .finally(() => setLoading(false));
  }, [flash]);

  useEffect(() => { loadData(); }, [loadData]);

  // â”€â”€â”€ Actions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  const updateUserPlan = async (userId: string, plan: string) => {
    const res = await fetch(`/api/admin/users/${userId}/plan`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      credentials: "include",
      body: JSON.stringify({ plan }),
    });
    if (res.ok) {
      flash(`Plan updated â†’ "${plan}"`);
      setEditingUser(null);
      loadData();
    } else {
      const e = await res.json().catch(() => ({}));
      flash(e.error || "Failed to update plan", false);
    }
  };

  const updateUserRole = async (userId: string, newRole: string) => {
    const res = await fetch(`/api/admin/users/${userId}/role`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      credentials: "include",
      body: JSON.stringify({ role: newRole }),
    });
    if (res.ok) {
      flash(`Role updated â†’ "${newRole}"`);
      loadData();
    } else {
      const e = await res.json().catch(() => ({}));
      flash(e.error || "Failed to update role", false);
    }
  };

  const addPlan = async (e: React.FormEvent) => {
    e.preventDefault();
    const res = await fetch("/api/admin/plans", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      credentials: "include",
      body: JSON.stringify({
        name: newPlan.name.toLowerCase().replace(/\s+/g, "_"),
        display_name: newPlan.name,
        price: parseFloat(newPlan.price) || 0,
        trial_days: parseInt(newPlan.trial_days) || 0,
        features: newPlan.features.split(",").map((f) => f.trim()).filter(Boolean),
        cta: newPlan.cta || "",
      }),
    });
    if (res.ok) {
      setNewPlan({ name: "", price: "", trial_days: "", features: "", cta: "" });
      flash("Plan added!");
      loadData();
    } else {
      const e = await res.json().catch(() => ({}));
      flash(e.error || "Failed to add plan", false);
    }
  };

  // â”€â”€â”€ Guard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  if (!user || user.role !== "admin") {
    return (
      <div className="corral-admin-panel">
        <div className="corral-admin-header">
          <h2>ğŸ”’ Admin Only</h2>
          <button className="corral-btn corral-btn-secondary" onClick={onClose}>â† Back</button>
        </div>
        <p style={{ textAlign: "center", color: "#888", marginTop: "3rem" }}>
          You need admin access to view this page.
        </p>
      </div>
    );
  }

  // â”€â”€â”€ Filtered users â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  const filteredUsers = searchQuery.trim()
    ? users.filter((u) =>
        u.name?.toLowerCase().includes(searchQuery.toLowerCase()) ||
        u.email.toLowerCase().includes(searchQuery.toLowerCase()) ||
        u.plan.toLowerCase().includes(searchQuery.toLowerCase())
      )
    : users;

  const planOptions = plans.map((p) => p.name);

  // â”€â”€â”€ Render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  return (
    <div className="corral-admin-panel">

      {/* Header */}
      <div className="corral-admin-header">
        <h2>âš™ï¸ Admin Dashboard</h2>
        <button className="corral-btn corral-btn-secondary" onClick={onClose}>â† Back</button>
      </div>

      {/* Toast notification */}
      {actionMsg && (
        <div className={`corral-toast ${actionMsg.ok ? "corral-toast-ok" : "corral-toast-err"}`}>
          {actionMsg.text}
        </div>
      )}

      {/* Stats row */}
      <div className="corral-admin-stats">
        <div className="corral-stat-card">
          <div className="corral-stat-number">{stats.total}</div>
          <div className="corral-stat-label">Total Users</div>
        </div>
        {Object.entries(stats.byPlan).map(([plan, count]) => (
          <div key={plan} className="corral-stat-card">
            <div className="corral-stat-number">{count}</div>
            <div className="corral-stat-label">{plan.charAt(0).toUpperCase() + plan.slice(1)}</div>
          </div>
        ))}
        <div className="corral-stat-card corral-stat-card--accent">
          <div className="corral-stat-number">{stats.admins}</div>
          <div className="corral-stat-label">Admins</div>
        </div>
      </div>

      {/* Tabs */}
      <div className="corral-admin-tabs">
        <button
          className={`corral-admin-tab${tab === "users" ? " active" : ""}`}
          onClick={() => setTab("users")}
        >
          Users ({stats.total})
        </button>
        <button
          className={`corral-admin-tab${tab === "plans" ? " active" : ""}`}
          onClick={() => setTab("plans")}
        >
          Plans ({plans.length})
        </button>
      </div>

      {/* â”€â”€ Users Tab â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */}
      {tab === "users" && (
        <div className="corral-admin-section">
          <div className="corral-table-toolbar">
            <input
              type="search"
              placeholder="Search by name, email, or planâ€¦"
              value={searchQuery}
              onChange={(e) => setSearchQuery(e.target.value)}
              className="corral-search"
            />
            <button className="corral-btn corral-btn-ghost" onClick={loadData} title="Refresh">
              â†º Refresh
            </button>
          </div>

          {loading ? (
            <div className="corral-loading">Loading usersâ€¦</div>
          ) : (
            <div className="corral-table-wrap">
              <table className="corral-admin-table">
                <thead>
                  <tr>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Plan</th>
                    <th>Role</th>
                    <th>Joined</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody>
                  {filteredUsers.map((u) => (
                    <tr key={u.id}>
                      <td className="corral-td-name">{u.name || <em style={{ opacity: 0.4 }}>â€”</em>}</td>
                      <td className="corral-td-email">{u.email}</td>

                      {/* Inline plan editor */}
                      <td>
                        {editingUser === u.id ? (
                          <select
                            defaultValue={u.plan}
                            onChange={(e) => updateUserPlan(u.id, e.target.value)}
                            onBlur={() => setEditingUser(null)}
                            autoFocus
                            className="corral-plan-select"
                          >
                            {planOptions.length > 0
                              ? planOptions.map((p) => (
                                  <option key={p} value={p}>{p}</option>
                                ))
                              : (
                                <>
                                  <option value="free">free</option>
                                  <option value="{{PAID_PLAN}}">{{PAID_PLAN}}</option>
                                </>
                              )
                            }
                          </select>
                        ) : (
                          <span
                            className={`corral-plan-badge corral-plan-${u.plan}`}
                            onClick={() => setEditingUser(u.id)}
                            title="Click to change plan"
                            style={{ cursor: "pointer" }}
                          >
                            {u.plan}
                          </span>
                        )}
                      </td>

                      {/* Role toggle */}
                      <td>
                        <span
                          className={`corral-role-badge corral-role-${u.role}`}
                          onClick={() =>
                            updateUserRole(u.id, u.role === "admin" ? "user" : "admin")
                          }
                          title={`Click to make ${u.role === "admin" ? "user" : "admin"}`}
                          style={{ cursor: "pointer" }}
                        >
                          {u.role}
                        </span>
                      </td>

                      <td className="corral-td-date">
                        {new Date(u.createdAt).toLocaleDateString()}
                      </td>

                      <td>
                        <button
                          className="corral-btn corral-btn-ghost corral-btn-small"
                          onClick={() => setEditingUser(u.id)}
                        >
                          Edit Plan
                        </button>
                      </td>
                    </tr>
                  ))}

                  {filteredUsers.length === 0 && (
                    <tr>
                      <td colSpan={6} style={{ textAlign: "center", padding: "2.5rem", opacity: 0.4 }}>
                        {searchQuery ? "No users match your search." : "No users yet."}
                      </td>
                    </tr>
                  )}
                </tbody>
              </table>
            </div>
          )}
        </div>
      )}

      {/* â”€â”€ Plans Tab â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */}
      {tab === "plans" && (
        <div className="corral-admin-section">

          {/* Plan cards grid */}
          {plans.length > 0 ? (
            <div className="corral-plan-cards">
              {plans.map((p) => (
                <div key={p.name} className="corral-plan-card">
                  <div className="corral-plan-card-name">
                    {p.display_name || p.name}
                  </div>
                  <div className="corral-plan-price">
                    {p.price === 0 ? "Free" : `$${p.price}/mo`}
                  </div>
                  {p.trial_days && p.trial_days > 0 ? (
                    <div className="corral-plan-trial">{p.trial_days}-day free trial</div>
                  ) : null}
                  <ul className="corral-plan-features">
                    {(p.features || []).map((f, i) => (
                      <li key={i}>âœ“ {f}</li>
                    ))}
                  </ul>
                  {p.cta && <div className="corral-plan-cta">{p.cta}</div>}
                </div>
              ))}
            </div>
          ) : (
            <p style={{ opacity: 0.5, marginBottom: "1.5rem" }}>
              No plans found in corral.yaml. Add one below or run:{" "}
              <code>npx create-corral add plan pro --price 29</code>
            </p>
          )}

          {/* Add new plan form */}
          <div className="corral-add-plan-form">
            <h3>Add New Plan</h3>
            <form onSubmit={addPlan} className="corral-form-stack">
              <div className="corral-form-row">
                <div className="corral-form-group">
                  <label className="corral-label">Plan Name</label>
                  <input
                    type="text"
                    placeholder="e.g. Pro"
                    value={newPlan.name}
                    onChange={(e) => setNewPlan({ ...newPlan, name: e.target.value })}
                    required
                    className="corral-input"
                  />
                </div>
                <div className="corral-form-group">
                  <label className="corral-label">Price ($/mo)</label>
                  <input
                    type="number"
                    placeholder="e.g. 29"
                    value={newPlan.price}
                    onChange={(e) => setNewPlan({ ...newPlan, price: e.target.value })}
                    required
                    step="0.01"
                    min="0"
                    className="corral-input"
                  />
                </div>
                <div className="corral-form-group">
                  <label className="corral-label">Trial Days</label>
                  <input
                    type="number"
                    placeholder="0 for none"
                    value={newPlan.trial_days}
                    onChange={(e) => setNewPlan({ ...newPlan, trial_days: e.target.value })}
                    min="0"
                    className="corral-input"
                  />
                </div>
              </div>
              <div className="corral-form-group">
                <label className="corral-label">Features (comma-separated)</label>
                <input
                  type="text"
                  placeholder="e.g. Priority support, API access, No watermark"
                  value={newPlan.features}
                  onChange={(e) => setNewPlan({ ...newPlan, features: e.target.value })}
                  className="corral-input"
                />
              </div>
              <div className="corral-form-group">
                <label className="corral-label">CTA Text (optional)</label>
                <input
                  type="text"
                  placeholder="e.g. Most popular"
                  value={newPlan.cta}
                  onChange={(e) => setNewPlan({ ...newPlan, cta: e.target.value })}
                  className="corral-input"
                />
              </div>
              <button type="submit" className="corral-btn" style={{ alignSelf: "flex-start" }}>
                Add Plan
              </button>
            </form>
          </div>

        </div>
      )}
    </div>
  );
}
