// {{APP_NAME}} â€” Account Commands (generated by Corral)
// Add to your CLI: program.addCommand(accountCommand);

import { Command } from 'commander';
import { CorralClient } from '@llamafarm/corral-client';

const corral = new CorralClient({
  baseURL: process.env.{{APP_ID_UPPER}}_URL || 'http://localhost:{{PORT}}',
  appName: '{{APP_ID}}',
});

export const accountCommand = new Command('account')
  .description('Manage your account');

accountCommand
  .command('login')
  .description('Sign in to your account')
  .option('--api-key', 'Authenticate with an API key')
  .action(async (opts) => {
    if (opts.apiKey) {
      const readline = await import('readline');
      const rl = readline.createInterface({ input: process.stdin, output: process.stdout });
      const key = await new Promise<string>(resolve => rl.question('ðŸ”‘ Enter your API key: ', resolve));
      rl.close();
      await corral.loginWithKey(key);
    } else {
      await corral.login();
    }
  });

accountCommand
  .command('logout')
  .description('Sign out and clear stored credentials')
  .action(async () => {
    await corral.logout();
  });

accountCommand
  .command('status')
  .alias('whoami')
  .description('Show current account info')
  .action(async () => {
    const user = await corral.getUser();
    if (!user) {
      console.log('Not logged in. Run: {{APP_ID}} account login');
      return;
    }
    console.log(`\nðŸ‘¤ ${user.name} (${user.email})`);
    console.log(`   Plan: ${user.plan}`);
    console.log(`   Role: ${user.role}`);
    console.log('');
  });

accountCommand
  .command('upgrade [plan]')
  .description('Upgrade your plan')
  .action(async (plan?: string) => {
    if (!plan) {
      // Show available plans
      console.log('\nðŸ’° Available plans:\n');
      // TODO: fetch from /api/corral/config
      console.log('   Usage: {{APP_ID}} account upgrade <plan>');
      console.log('   Example: {{APP_ID}} account upgrade pro\n');
      return;
    }
    await corral.upgrade(plan);
  });

accountCommand
  .command('token')
  .description('Print current access token')
  .action(async () => {
    const user = await corral.getUser();
    if (!user) {
      console.error('Not logged in.');
      process.exit(1);
    }
    // Read token from credentials file
    const { readFileSync } = await import('fs');
    const { join } = await import('path');
    const { homedir } = await import('os');
    try {
      const creds = JSON.parse(readFileSync(join(homedir(), '.config', '{{APP_ID}}', 'credentials.json'), 'utf-8'));
      process.stdout.write(creds.accessToken);
    } catch {
      console.error('No token found.');
      process.exit(1);
    }
  });
