// {{APP_NAME}} â€” Corral Auth Server (Express)
// Standalone auth server for SPA (React/Vite) apps.
// Run with: npx tsx server/auth.ts (or add to package.json scripts)
//
// Your React app talks to this server for all auth operations.
// Set CORRAL_PORT (default {{PORT}}) and configure your Vite/CRA proxy.

import express from "express";
import cors from "cors";
import { toNodeHandler } from "better-auth/node";
import { auth } from "./corral.js";

const app = express();
const port = parseInt(process.env.CORRAL_PORT || "{{PORT}}");

// CORS: allow all common dev ports. Set CORS_ORIGIN in production.
const allowedOrigins = (process.env.CORS_ORIGIN || "http://localhost:{{FRONTEND_PORT}},http://localhost:3000,http://localhost:4000,http://localhost:5173")
  .split(",")
  .flatMap(o => [o.trim(), o.trim().replace("localhost", "127.0.0.1")])
  .filter(Boolean);

app.use(cors({
  origin: allowedOrigins,
  credentials: true,
}));

// Mount Better Auth â€” /api/auth/* works in BOTH Express 4 and 5
const authHandler = toNodeHandler(auth);
app.all("/api/auth/*", (req, res) => authHandler(req, res));

app.use(express.json());

// â”€â”€â”€ Admin + Profile + Billing API â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// These routes are auto-generated by Corral. Edit freely.

async function requireAuth(req: any) {
  const session = await auth.api.getSession({ headers: req.headers as any });
  if (!session?.user) throw new Error("Authentication required");
  return session;
}

async function requireAdmin(req: any) {
  const session = await requireAuth(req);
  if ((session.user as any).role !== "admin") throw new Error("Admin access required");
  return session;
}

// Admin: list users
app.get("/api/admin/users", async (req, res) => {
  try {
    await requireAdmin(req);
    const Database = (await import("better-sqlite3")).default;
    const db = new Database(require("path").resolve(process.cwd(), "corral.db"));
    const users = db.prepare('SELECT id, name, email, role, plan, createdAt FROM "user" ORDER BY createdAt DESC').all();
    db.close();
    res.json({ users });
  } catch (e: any) { res.status(403).json({ error: e.message }); }
});

// Admin: update user plan
app.put("/api/admin/users/:id/plan", async (req, res) => {
  try {
    await requireAdmin(req);
    const Database = (await import("better-sqlite3")).default;
    const db = new Database(require("path").resolve(process.cwd(), "corral.db"));
    db.prepare('UPDATE "user" SET plan = ?, updatedAt = datetime("now") WHERE id = ?').run(req.body.plan, req.params.id);
    db.close();
    res.json({ ok: true });
  } catch (e: any) { res.status(403).json({ error: e.message }); }
});

// Admin: toggle user role
app.put("/api/admin/users/:id/role", async (req, res) => {
  try {
    await requireAdmin(req);
    const Database = (await import("better-sqlite3")).default;
    const db = new Database(require("path").resolve(process.cwd(), "corral.db"));
    db.prepare('UPDATE "user" SET role = ?, updatedAt = datetime("now") WHERE id = ?').run(req.body.role, req.params.id);
    db.close();
    res.json({ ok: true });
  } catch (e: any) { res.status(403).json({ error: e.message }); }
});

// Profile: update name
app.put("/api/profile/name", async (req, res) => {
  try {
    const session = await requireAuth(req);
    const Database = (await import("better-sqlite3")).default;
    const db = new Database(require("path").resolve(process.cwd(), "corral.db"));
    db.prepare('UPDATE "user" SET name = ?, updatedAt = datetime("now") WHERE id = ?').run(req.body.name, session.user.id);
    db.close();
    res.json({ ok: true });
  } catch (e: any) { res.status(401).json({ error: e.message }); }
});

// Profile: change password
app.put("/api/profile/password", async (req, res) => {
  try {
    await auth.api.changePassword({
      body: { currentPassword: req.body.currentPassword, newPassword: req.body.newPassword },
      headers: req.headers as any,
    });
    res.json({ ok: true });
  } catch (e: any) { res.status(400).json({ error: e.message || "Failed to change password" }); }
});

// Profile: delete account
app.delete("/api/profile/delete", async (req, res) => {
  try {
    const session = await requireAuth(req);
    if (req.body.confirmEmail !== session.user.email) return res.status(400).json({ error: "Email doesn't match" });
    const Database = (await import("better-sqlite3")).default;
    const db = new Database(require("path").resolve(process.cwd(), "corral.db"));
    db.prepare('DELETE FROM "session" WHERE userId = ?').run(session.user.id);
    db.prepare('DELETE FROM "account" WHERE userId = ?').run(session.user.id);
    db.prepare('DELETE FROM "user" WHERE id = ?').run(session.user.id);
    db.close();
    res.json({ ok: true });
  } catch (e: any) { res.status(401).json({ error: e.message }); }
});

// Billing: Stripe Checkout
app.post("/api/billing/checkout", async (req, res) => {
  try {
    const session = await requireAuth(req);
    const stripeKey = process.env.STRIPE_SECRET_KEY;
    if (!stripeKey) return res.status(500).json({ error: "STRIPE_SECRET_KEY not set" });

    const { createRequire } = await import("module");
    const require_ = createRequire(process.cwd() + "/package.json");
    const Stripe = require_("stripe");
    const stripe = new Stripe(stripeKey);

    // Read price ID from corral.yaml
    const fs = await import("fs");
    const path = await import("path");
    const yamlPaths = ["corral.yaml", "../corral.yaml", "../frontend/corral.yaml"];
    let priceId = "";
    const plan = req.body.plan || "{{DEFAULT_PAID_PLAN}}";

    for (const p of yamlPaths) {
      const resolved = path.resolve(process.cwd(), p);
      if (fs.existsSync(resolved)) {
        const content = fs.readFileSync(resolved, "utf-8");
        const regex = new RegExp(`name:\\s*${plan}[\\s\\S]*?stripe_price_id:\\s*["']?(\\S+)`);
        const match = content.match(regex);
        if (match) priceId = match[1].replace(/["']/g, "");
        break;
      }
    }

    if (!priceId) return res.status(500).json({ error: `No Stripe price for plan "${plan}". Run: create-corral stripe push` });

    const frontendUrl = process.env.APP_URL || "http://localhost:{{FRONTEND_PORT}}";
    const checkoutSession = await stripe.checkout.sessions.create({
      mode: "subscription",
      customer_email: session.user.email,
      line_items: [{ price: priceId, quantity: 1 }],
      subscription_data: { trial_period_days: {{TRIAL_DAYS}} || undefined },
      success_url: `${frontendUrl}/?upgraded=true`,
      cancel_url: `${frontendUrl}/?cancelled=true`,
      metadata: { userId: session.user.id, plan },
    });

    res.json({ url: checkoutSession.url });
  } catch (e: any) { res.status(500).json({ error: e.message }); }
});

// Billing: Stripe Webhook
app.post("/api/billing/webhook", express.raw({ type: "application/json" }), async (req, res) => {
  try {
    const event = req.body;
    if (event.type === "checkout.session.completed") {
      const data = event.data.object;
      if (data.metadata?.plan && data.metadata?.userId) {
        const Database = (await import("better-sqlite3")).default;
        const db = new Database(require("path").resolve(process.cwd(), "corral.db"));
        db.prepare('UPDATE "user" SET plan = ? WHERE id = ?').run(data.metadata.plan, data.metadata.userId);
        db.close();
        console.log(`ðŸ¤  Corral: Plan upgraded â†’ ${data.metadata.userId} â†’ ${data.metadata.plan}`);
      }
    }
    res.json({ received: true });
  } catch { res.status(400).send(); }
});

// Health check
app.get("/health", (_req, res) => res.json({ ok: true }));

// Bind to 0.0.0.0 â€” default may only bind IPv6
app.listen(port, "0.0.0.0", () => {
  console.log(`ðŸ¤  Corral auth server running on http://localhost:${port}`);
  console.log(`   Auth:    http://localhost:${port}/api/auth/*`);
  console.log(`   Admin:   http://localhost:${port}/api/admin/*`);
  console.log(`   Billing: http://localhost:${port}/api/billing/*`);
});
