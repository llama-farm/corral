// {{APP_NAME}} â€” Corral Auth + Billing Server (Express)
// Full-featured: auth, checkout, billing portal, webhooks, device auth
// Run with: npx tsx server/auth.ts

import express from "express";
import cors from "cors";
import { toNodeHandler } from "better-auth/node";
import { auth } from "./corral.js";
import { createCorralRoutes } from "@llamafarm/corral/routes";

const app = express();
const port = parseInt(process.env.CORRAL_PORT || "{{PORT}}");
const corsOrigin = process.env.CORS_ORIGIN || "http://localhost:5173";

// â”€â”€â”€ Stripe (optional â€” billing features) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let stripe: any = null;
if (process.env.STRIPE_SECRET_KEY) {
  const Stripe = (await import("stripe")).default;
  stripe = new Stripe(process.env.STRIPE_SECRET_KEY);
  console.log("ðŸ’³ Stripe connected");
}

// â”€â”€â”€ CORS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
app.use(cors({
  origin: [corsOrigin, corsOrigin.replace("localhost", "127.0.0.1")],
  credentials: true,
}));

// â”€â”€â”€ Stripe Webhook (must be before json parser â€” needs raw body) â”€â”€
if (stripe && process.env.STRIPE_WEBHOOK_SECRET) {
  app.post("/webhook/stripe",
    express.raw({ type: "application/json" }),
    async (req, res) => {
      try {
        const event = stripe.webhooks.constructEvent(
          req.body, req.headers["stripe-signature"]!, process.env.STRIPE_WEBHOOK_SECRET!
        );

        console.log(`[Stripe] ${event.type}`);

        switch (event.type) {
          case "checkout.session.completed": {
            const session = event.data.object;
            const userId = session.metadata?.userId;
            const planId = session.metadata?.planId;
            if (userId && planId) {
              // Update user plan in database
              // TODO: Use auth.api or direct DB query
              console.log(`[Stripe] User ${userId} â†’ plan ${planId}`);
            }
            break;
          }
          case "customer.subscription.deleted": {
            const sub = event.data.object;
            const userId = sub.metadata?.userId;
            if (userId) {
              console.log(`[Stripe] User ${userId} â†’ plan free (subscription canceled)`);
            }
            break;
          }
          case "invoice.payment_failed": {
            console.log(`[Stripe] Payment failed for ${event.data.object.customer}`);
            break;
          }
        }

        res.json({ received: true });
      } catch (err: any) {
        console.error(`[Stripe] Webhook error: ${err.message}`);
        res.status(400).send(`Webhook Error: ${err.message}`);
      }
    }
  );
  console.log("ðŸ”” Stripe webhooks enabled at /webhook/stripe");
}

// â”€â”€â”€ JSON parser (after webhook route) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
app.use(express.json());

// â”€â”€â”€ Better Auth â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const authHandler = toNodeHandler(auth);
try {
  app.all("/api/auth/*", (req, res) => authHandler(req, res));
} catch {
  app.all("/api/auth/*", (req, res) => authHandler(req, res));
}

// â”€â”€â”€ Corral API (checkout, billing, device auth) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const plans = [
  // TODO: Load from corral.yaml
  { id: "free", name: "Free", price: 0, period: "forever", features: ["Basic access"], stripePriceId: undefined },
  { id: "pro", name: "Pro", price: 29, period: "/month", features: ["Everything"], highlighted: true, trialDays: 14,
    stripePriceId: process.env.STRIPE_PRICE_PRO },
];

const corralHandler = createCorralRoutes(auth, stripe, {
  plans,
  webhookSecret: process.env.STRIPE_WEBHOOK_SECRET,
  successUrl: corsOrigin,
  cancelUrl: corsOrigin,
});
app.use("/api/corral", (req, res) => corralHandler(req, res));

// â”€â”€â”€ Health check â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
app.get("/health", (_req, res) => res.json({ ok: true, stripe: !!stripe }));

// â”€â”€â”€ Start â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
app.listen(port, "0.0.0.0", () => {
  console.log(`ðŸ¤  Corral server running on http://localhost:${port}`);
  console.log(`   Auth: http://localhost:${port}/api/auth/*`);
  console.log(`   API:  http://localhost:${port}/api/corral/*`);
  console.log(`   CORS: ${corsOrigin}`);
});
