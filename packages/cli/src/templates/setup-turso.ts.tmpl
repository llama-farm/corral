// {{APP_NAME}} â€” Corral Auth Setup (Turso / libSQL)
// Edge-native SQLite â€” works with Turso cloud, local libSQL, or embedded replicas.
// Set in .env:
//   TURSO_URL=libsql://your-db-name-org.turso.io
//   TURSO_AUTH_TOKEN=your-token
//   Or local: TURSO_URL=file:./corral.db (no token needed)

import { betterAuth } from "better-auth";
import { admin } from "better-auth/plugins";
import { createClient } from "@libsql/client";

const turso = createClient({
  url: process.env.TURSO_URL || "file:./corral.db",
  authToken: process.env.TURSO_AUTH_TOKEN,
});

// Auto-bootstrap tables (SQLite-compatible syntax)
async function bootstrapDatabase() {
  const statements = [
    `CREATE TABLE IF NOT EXISTS "user" (
      id TEXT PRIMARY KEY,
      name TEXT NOT NULL,
      email TEXT NOT NULL UNIQUE,
      emailVerified INTEGER NOT NULL DEFAULT 0,
      image TEXT,
      plan TEXT NOT NULL DEFAULT 'free',
      createdAt TEXT NOT NULL DEFAULT (datetime('now')),
      updatedAt TEXT NOT NULL DEFAULT (datetime('now')),
      role TEXT DEFAULT 'user',
      banned INTEGER DEFAULT 0,
      banReason TEXT,
      banExpires TEXT
    )`,
    `CREATE TABLE IF NOT EXISTS "session" (
      id TEXT PRIMARY KEY,
      userId TEXT NOT NULL REFERENCES "user"(id) ON DELETE CASCADE,
      token TEXT NOT NULL UNIQUE,
      expiresAt TEXT NOT NULL,
      ipAddress TEXT,
      userAgent TEXT,
      createdAt TEXT NOT NULL DEFAULT (datetime('now')),
      updatedAt TEXT NOT NULL DEFAULT (datetime('now'))
    )`,
    `CREATE TABLE IF NOT EXISTS "account" (
      id TEXT PRIMARY KEY,
      userId TEXT NOT NULL REFERENCES "user"(id) ON DELETE CASCADE,
      accountId TEXT NOT NULL,
      providerId TEXT NOT NULL,
      accessToken TEXT,
      refreshToken TEXT,
      accessTokenExpiresAt TEXT,
      refreshTokenExpiresAt TEXT,
      scope TEXT,
      password TEXT,
      createdAt TEXT NOT NULL DEFAULT (datetime('now')),
      updatedAt TEXT NOT NULL DEFAULT (datetime('now'))
    )`,
    `CREATE TABLE IF NOT EXISTS "verification" (
      id TEXT PRIMARY KEY,
      identifier TEXT NOT NULL,
      value TEXT NOT NULL,
      expiresAt TEXT NOT NULL,
      createdAt TEXT NOT NULL DEFAULT (datetime('now')),
      updatedAt TEXT NOT NULL DEFAULT (datetime('now'))
    )`,
    `CREATE TABLE IF NOT EXISTS "subscription" (
      id TEXT PRIMARY KEY,
      plan TEXT NOT NULL DEFAULT 'free',
      referenceId TEXT NOT NULL,
      stripeCustomerId TEXT,
      stripeSubscriptionId TEXT,
      status TEXT,
      periodStart TEXT,
      periodEnd TEXT,
      cancelAtPeriodEnd INTEGER DEFAULT 0,
      seats INTEGER DEFAULT 1
    )`,
    `CREATE INDEX IF NOT EXISTS idx_session_token ON "session"(token)`,
    `CREATE INDEX IF NOT EXISTS idx_session_userId ON "session"(userId)`,
    `CREATE INDEX IF NOT EXISTS idx_account_userId ON "account"(userId)`,
    `CREATE INDEX IF NOT EXISTS idx_user_email ON "user"(email)`,
  ];

  for (const sql of statements) {
    await turso.execute(sql);
  }
  console.log("ðŸ“¦ Database tables ready");
}

bootstrapDatabase().catch(err => {
  console.error("Failed to bootstrap database:", err.message);
});

const corsOrigin = process.env.CORS_ORIGIN || "http://localhost:5173";

export const auth = betterAuth({
  // Turso/libSQL: use the { db, type } format since it's not a standard SQLite instance
  database: {
    db: turso,
    type: "sqlite",
  },
  baseURL: process.env.BETTER_AUTH_URL || "http://localhost:{{PORT}}",
  basePath: "/api/auth",
  secret: process.env.BETTER_AUTH_SECRET,
  emailAndPassword: { enabled: true },
  plugins: [admin()],
  session: { expiresIn: 60 * 60 * 24 * 30 },
  user: {
    additionalFields: {
      plan: {
        type: "string" as const,
        defaultValue: "free",
      },
    },
  },
  trustedOrigins: [
    corsOrigin,
    corsOrigin.replace("localhost", "127.0.0.1"),
  ],
});

export type Session = typeof auth.$Infer.Session;
