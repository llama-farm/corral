# CORRAL.md — Agent Guide for {{APP_NAME}}

> Auto-generated by `corral init`. Updated automatically by `corral add` commands.
> Helps AI agents (Claude Code, Codex, Cursor, OpenClaw) understand and modify auth/billing.
> Source of truth: `corral.yaml` — edit that file, not the generated TypeScript.

---

## What's Running

**App:** {{APP_NAME}}
**Framework:** {{FRAMEWORK}}
**Database:** {{DB_ADAPTER}} at `{{DB_URL}}`
**Auth:** Better Auth, mounted at `/api/auth/*`
**Billing:** Stripe (sync plans with `corral stripe push`)
**Admin panel:** `/admin` (requires `role: admin`)

---

## Key Files

```
corral.yaml             ← edit this for ALL config changes
CORRAL.md               ← this file (auto-updated)
lib/corral.ts           ← Better Auth instance (don't edit directly)
{{SERVER_FILE}}         ← auth server/route mount point
.env{{ENV_SUFFIX}}      ← BETTER_AUTH_SECRET, STRIPE_SECRET_KEY, etc.
```

---

## How to Test (after init)

```bash
# 1. Start the server
{{START_COMMAND}}

# 2. Health check
curl http://localhost:{{PORT}}/api/auth/ok
# → { "ok": true }

# 3. Sign up
curl -X POST http://localhost:{{PORT}}/api/auth/sign-up/email \
  -H "Content-Type: application/json" \
  -d '{"email":"test@example.com","password":"test1234","name":"Test"}'

# 4. Sign in
curl -X POST http://localhost:{{PORT}}/api/auth/sign-in/email \
  -H "Content-Type: application/json" \
  -d '{"email":"test@example.com","password":"test1234"}'

# 5. Admin panel — visit in browser (sign in as seed.admin from corral.yaml)
open http://localhost:{{PORT}}/admin

# 6. Pricing / upgrade flow
open http://localhost:{{PORT}}/pricing
```

---

## What's Configured

### Plans (from corral.yaml)
Edit `corral.yaml` to add/modify plans. After adding paid plans, run `corral stripe push`.

```bash
corral add plan <name> --price <n> [--trial <days>] [--cta <text>]
corral stripe push    # sync to Stripe, writes stripe_price_id back to corral.yaml
```

### Usage Meters (from corral.yaml)
```bash
corral add meter <name> --limit <n> --plan <plan>
# or shorthand:
corral add meter <name> --free 100 --pro 10000
```

### Feature Gating (from corral.yaml)
```bash
corral add feature <name> --plan <plan>
# In code: hasFeature(user, 'feature_name')
# In JSX: <FeatureGate feature="feature_name">…</FeatureGate>
```

---

## Admin User

The seed admin is auto-created on first boot from `corral.yaml`:
```yaml
seed:
  admin:
    email: admin@example.com   # ← change this
    password: admin123          # ← change this
    name: Admin
```

To make an existing user admin:
```bash
# Via CLI (if available):
corral users set-role --email user@example.com --role admin

# Or directly in DB:
# SQLite: sqlite3 corral.db "UPDATE user SET role='admin' WHERE email='...'"
# PostgreSQL: psql $DATABASE_URL -c "UPDATE \"user\" SET role='admin' WHERE email='...'"
```

---

## Quick Reference

```bash
corral doctor                        # health check — run this if anything seems wrong
corral stripe push                   # sync plans to Stripe
corral seed                          # re-seed database from corral.yaml
corral status                        # show users, plans, MRR
corral rollback                      # undo last change

corral add plan <name> --price <n>   # add a billing plan
corral add meter <name> --limit <n> --plan <plan>
corral add feature <name> --plan <plan>
corral add page <path> [--gated <plan>]
corral add provider google           # add OAuth provider
corral add webhook                   # Stripe webhook handler
```

---

## Auth Endpoints

All endpoints are under `/api/auth/`:
- `GET  /api/auth/ok`                    — health check
- `POST /api/auth/sign-up/email`         — `{ email, password, name }`
- `POST /api/auth/sign-in/email`         — `{ email, password }`
- `POST /api/auth/sign-out`
- `GET  /api/auth/get-session`           — current user + session
- `GET  /api/auth/sign-in/social?provider=google&callbackURL=/`

---

## Billing Endpoints

All endpoints under `/api/corral/`:
- `POST /api/corral/checkout`            — `{ planId }` → `{ url }` (Stripe checkout URL)
- `GET  /api/corral/billing`             — subscription + invoices
- `POST /api/corral/cancel`              — cancel at period end
- `GET  /api/corral/subscription/status` — `{ plan, role }`

---

## ⚠️ Common Gotchas (for agents)

### 1. Express Route Syntax
**Express 4 uses `/*`, NOT `/*splat`** (that is Express 5 syntax).
```typescript
// ✅ CORRECT
app.all('/api/auth/*', (req, res) => authHandler(req, res));
// ❌ WRONG (Express 5 only)
app.all('/api/auth/*splat', (req, res) => authHandler(req, res));
```

### 2. Don't Scaffold a Separate Auth Server
If Corral is already initialized, don't add another auth server.
Corral mounts into your existing server automatically.
Run `corral doctor` to verify the mount is working.

### 3. After Init, Everything Should Work Immediately
Sign up, sign in, admin panel, profile, upgrade flow — all functional after `corral init`.
If something doesn't work, run `corral doctor` first.

### 4. Database Adapter Requires a Driver Instance
Better Auth takes a **driver instance**, not a URL string.
Corral's `lib/corral.ts` handles this correctly — don't change it.

### 5. Environment Variables
- `BETTER_AUTH_SECRET` — must be set (min 32 chars), or session signing fails silently
- `BETTER_AUTH_URL` — must match your server's actual URL
- `STRIPE_SECRET_KEY` — needed for `corral stripe push` and checkout
- Next.js: put vars in `.env.local` (not `.env`)

### 6. Modifying Plans
Edit `corral.yaml` directly. After adding/changing paid plans:
```bash
corral stripe push    # creates/updates Stripe products + prices
```
The `stripe_price_id` fields in `corral.yaml` are auto-filled by this command.

### 7. Database Tables
Tables are auto-created on first boot (`CREATE TABLE IF NOT EXISTS`).
No manual migration needed. If you see "no such table: user", the server didn't start correctly.
Check that `lib/corral.ts` is imported before any route that needs auth.
