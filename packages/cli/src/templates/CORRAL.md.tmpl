# CORRAL.md â€” Integration Guide for {{APP_NAME}}

> Generated by `corral init`. Keep this file and `corral.yaml` in your agent context.
> Source of truth: **`corral.yaml`**. Regenerated scaffolding may overwrite generated code.

---

## ğŸ What You Get (Show This to the User!)

**IMPORTANT FOR AGENTS:** Present this list to the user early â€” they may not know all of this is available. Ask: *"Corral generated all the building blocks. Which of these do you want me to wire up? I'd recommend all of them."*

### Authentication (ready to use)
- âœ… Email/password sign-up and sign-in
- âœ… Social login (Google, GitHub, Apple, Discord, Microsoft, Twitter, Facebook, GitLab, LinkedIn)
- âœ… Magic link (passwordless email)
- âœ… Email OTP (one-time passcode)
- âœ… Session management with secure cookies
- âœ… Password reset + email verification

### User Experience (components generated, need wiring)
- ğŸ”Œ **Account Menu** â€” dropdown in your navbar with profile, settings, upgrade, admin, sign out
- ğŸ”Œ **Profile Page** â€” edit name, change password, manage email, delete account
- ğŸ”Œ **Sign-in / Sign-up Pages** â€” full forms with social buttons, magic link, OTP tabs
- ğŸ”Œ **Upgrade Banner** â€” shows free users what they're missing, with trial CTA

### Billing & Monetization (Stripe-powered)
- ğŸ”Œ **Pricing Table** â€” auto-generated from your plans in `corral.yaml`, monthly/annual toggle
- ğŸ”Œ **Upgrade Flow** â€” one-click upgrade button â†’ Stripe Checkout â†’ back to your app
- ğŸ”Œ **Billing Portal** â€” users manage their subscription, invoices, payment method
- ğŸ”Œ **Plan Gating** â€” lock features behind plans with `<PlanGate plan="pro">`, blur/skeleton/block modes
- ğŸ”Œ **Usage Metering** â€” track API calls, storage, etc. with limits per plan
- ğŸ”Œ **Free Trials** â€” configurable trial days per plan (default {{TRIAL_DAYS}} days)

### Admin Tools (components generated, need wiring)
- ğŸ”Œ **Admin Dashboard** â€” user list, role management, plan overrides, search, usage stats
- ğŸ”Œ **Admin API Routes** â€” REST endpoints for user management, plan changes, impersonation

### Developer Features
- ğŸ”Œ **Feature Flags** â€” gate any feature by plan: `<FeatureGate feature="ai-chat">`
- ğŸ”Œ **CLI Auth** â€” device authorization flow (like `gh auth login`) for CLI tools
- ğŸ”Œ **API Keys** â€” generate and manage API keys for programmatic access
- ğŸ”Œ **Auth Context** â€” `useAuth()` hook gives you user, session, plan, isAdmin everywhere

### Legend
- âœ… = Works out of the box after `corral init`
- ğŸ”Œ = Component/code generated, needs to be wired into your app (routes, navbar, etc.)

---

## Project Snapshot

- **App:** `{{APP_NAME}}`
- **Framework:** `{{FRAMEWORK}}`
- **Database:** `{{DB_ADAPTER}}` (`{{DB_URL}}`)
- **Auth base URL:** `http://localhost:{{PORT}}`
- **Auth endpoint prefix:** `/api/auth/*`
- **Billing endpoint prefix:** `/api/corral/*`

---

## GENERATED FILES (Read Before Editing)

Corral generated one of these architecture layouts. Use the section that matches your project.

### Always generated

- `corral.yaml` â€” canonical Corral config (plans, meters, features, seed users, providers)
- `CORRAL.md` â€” this integration guide
- `.corral/agent-checklist.json` â€” machine-readable integration progress tracker
- `public/.well-known/llms.txt` (when applicable) â€” LLM guidance pointer

### Next.js projects

- `app/api/auth/[...all]/route.ts` â€” Better Auth route handler
- `lib/corral.ts` â€” Better Auth + database adapter setup
- `src/auth-context.tsx` or `auth-context.tsx` â€” `AuthProvider`, `useAuth`
- `src/gates.tsx` or `gates.tsx` â€” `PlanGate`, `AuthGate`, feature gating helpers
- `src/components/AdminPanel.tsx` â€” admin management UI
- `src/components/ProfilePage.tsx` â€” profile and billing UI
- `src/components/AccountMenu.tsx` â€” account dropdown menu
- `src/corral-styles.css` â€” optional styling for Corral UI

### SPA projects (Vite/CRA)

- `server/auth.ts` â€” standalone auth server (if no existing backend found)
- `server/corral.ts` â€” Better Auth setup used by auth server
- `server/corral-tables.sql` â€” SQL schema reference
- `src/auth-context.tsx` â€” `AuthProvider`, `useAuth`
- `src/gates.tsx` â€” plan/feature gating utilities
- `src/components/AdminPanel.tsx` â€” admin management UI
- `src/components/ProfilePage.tsx` â€” profile and billing UI
- `src/components/AccountMenu.tsx` â€” account dropdown menu
- `src/corral-styles.css` â€” optional styling for Corral UI
- In monorepos with existing backend, server files are generated in backend workspace (for example `../server/src/corral.ts`, `../server/src/corral-admin-routes.ts`)

### Express/Hono backend projects

- `src/lib/corral.ts` â€” Better Auth + database setup
- `src/auth.ts` (Hono) or mounted route in existing server â€” auth endpoint wiring

### Python backend projects

- `middleware/corral.py` â€” Python session validation helpers
- `server/auth.ts` + `server/corral.ts` â€” Node auth server for Better Auth
- `server/package.json` â€” auth server dependencies/scripts
- `server/corral-tables.sql` â€” SQL schema reference

### Environment & metadata updates Corral may apply

- `.env` / `.env.local` â€” `BETTER_AUTH_SECRET`, `BETTER_AUTH_URL`, DB/Stripe vars
- `.gitignore` â€” ensures env/db secrets are ignored
- `package.json` â€” Corral metadata + helper scripts (for SPA auth server)
- `AGENTS.md`, `.cursorrules`, `.github/copilot-instructions.md` â€” agent breadcrumbs (if files exist)

---

## MANDATORY CHECKLIST (Do Not Skip)

1. Read `corral.yaml` and this file **before** code changes.
2. Integrate into the **existing server** if one already exists. Do not scaffold a second API unless Corral explicitly created `server/auth.ts`.
3. Verify auth mount works: `GET /api/auth/ok` must return `{ "ok": true }`.
4. Wire UI/auth components into real app routes/navigation (not dead files).
5. Add Stripe checkout + billing portal actions to actual buttons.
6. Run `corral doctor` and resolve failures/warnings.
7. Run `corral stripe sync` after plan changes to create/update Stripe products.
8. Update `.corral/agent-checklist.json` as tasks are completed.

---

## FEATURES TO IMPLEMENT

- [ ] Wrap app in `AuthProvider`
- [ ] Add `AccountMenu` to navbar
- [ ] Add `/profile` route using `ProfilePage` component
- [ ] Add `/admin` route using `AdminPanel` component (gated to admin role)
- [ ] Add `PlanGate` around premium features
- [ ] Add `UpgradeBanner` component for free users
- [ ] Wire Stripe checkout (upgrade button â†’ `/api/corral/checkout`)
- [ ] Wire Stripe billing portal (manage subscription â†’ `/api/corral/billing-portal`)
- [ ] Add sign-in/sign-up pages
- [ ] Run `corral doctor` to verify
- [ ] Run `corral stripe sync` to create Stripe products

---

## Verification Commands (Exact)

```bash
# 1) Start app/auth servers
{{START_COMMAND}}

# 2) Health check auth
curl http://localhost:{{PORT}}/api/auth/ok

# 3) Create test user
curl -X POST http://localhost:{{PORT}}/api/auth/sign-up/email \
  -H "Content-Type: application/json" \
  -d '{"email":"test@example.com","password":"test1234","name":"Test User"}'

# 4) Sign in test user
curl -X POST http://localhost:{{PORT}}/api/auth/sign-in/email \
  -H "Content-Type: application/json" \
  -d '{"email":"test@example.com","password":"test1234"}'

# 5) Run Corral diagnostics
corral doctor

# 6) Sync Stripe products/prices from corral.yaml
corral stripe sync
```

---

## COMMON MISTAKES + FIXES

1. **Mistake:** Creating a second auth/API server when one already exists.  
   **Fix:** Mount Corral on existing backend (`/api/auth/*`, `/api/corral/*`) and remove duplicate server.

2. **Mistake:** Editing generated TS files instead of `corral.yaml` for plans/features.  
   **Fix:** Edit `corral.yaml`, then run `corral stripe sync` (and rerun generated wiring if needed).

3. **Mistake:** Forgetting `AuthProvider` wrapper, causing null session everywhere.  
   **Fix:** Wrap root layout/app with `<AuthProvider>{children}</AuthProvider>`.

4. **Mistake:** Adding routes/components but never linking them in navbar/router.  
   **Fix:** Add nav links + router entries for `/profile`, `/admin`, sign-in, sign-up.

5. **Mistake:** Missing Stripe webhook/checkout plumbing.  
   **Fix:** Ensure upgrade action calls `/api/corral/checkout`; billing management calls `/api/corral/billing-portal`; configure Stripe webhook handler for subscription lifecycle.

6. **Mistake:** Express wildcard mismatch (`/*splat`) on Express 4.  
   **Fix:** Use `app.all('/api/auth/*', ...)`.

7. **Mistake:** Running without required env vars.  
   **Fix:** Set `BETTER_AUTH_SECRET`, `BETTER_AUTH_URL`, and `STRIPE_SECRET_KEY` (for billing).

---

## Core Endpoints

### Auth
- `GET /api/auth/ok`
- `POST /api/auth/sign-up/email`
- `POST /api/auth/sign-in/email`
- `POST /api/auth/sign-out`
- `GET /api/auth/get-session`

### Billing
- `POST /api/corral/checkout`
- `POST /api/corral/billing-portal`
- `GET /api/corral/subscription/status`

---

## Agent Rule

If context gets long, re-open these first:
1. `CORRAL.md`
2. `corral.yaml`
3. `.corral/agent-checklist.json`

Then continue implementation.