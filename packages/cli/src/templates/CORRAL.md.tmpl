# CORRAL.md — Agent Instructions for {{APP_NAME}}

> Auto-generated by `corral init`. This file helps AI agents (Claude Code, Codex, Cursor, OpenClaw) understand and modify the auth/billing setup.

## Overview
This project uses **Corral** (Better Auth + Stripe) for authentication and billing.
- Config: `corral.yaml` (single source of truth)
- Server setup: `lib/corral.ts`
- Auth routes: `app/api/auth/[...all]/route.ts`
- CLI: `corral <command>`

## Quick Commands
```bash
corral doctor          # Check everything works (run this first!)
corral dev             # Start dev server with seeded data
corral seed            # Seed database with test users
corral config validate # Validate corral.yaml
corral stripe sync     # Sync plans to Stripe
corral users list      # List all users
corral status          # Health check
```

## Architecture

### Next.js (full-stack)
```
corral.yaml           → Plans, meters, nudges, branding
lib/corral.ts         → Better Auth server instance (SERVER-ONLY)
app/api/auth/[...all] → Catch-all route handler for all auth endpoints
components/corral/    → UI components (login, signup, settings, admin)
.env.local            → BETTER_AUTH_SECRET, BETTER_AUTH_URL, STRIPE_SECRET_KEY
```

### React SPA (Vite/CRA) — standalone auth server
```
corral.yaml           → Plans, meters, nudges, branding
server/corral.ts      → Better Auth server instance (runs as separate process)
server/auth.ts        → Express server entrypoint (npx tsx server/auth.ts)
src/components/corral/ → UI components (login, signup, settings, admin)
.env                  → BETTER_AUTH_SECRET, BETTER_AUTH_URL, CORS_ORIGIN, CORRAL_PORT
vite.config.ts        → Proxy /api/auth → localhost:3001 (dev only)
```

**SPA key difference:** Auth runs as a separate Express server on port 3001.
In dev, Vite proxies `/api/auth` to it. In production, configure your reverse proxy (nginx/Caddy).

## Auth Endpoints (all under /api/auth/)
- `GET  /api/auth/ok` — Health check
- `POST /api/auth/sign-up/email` — Register
- `POST /api/auth/sign-in/email` — Login  
- `GET  /api/auth/session` — Get current session
- `POST /api/auth/sign-out` — Logout
- `GET  /api/auth/admin/*` — Admin endpoints

## Required Environment Variables
```env
BETTER_AUTH_SECRET=<min 32 chars, generate with: openssl rand -base64 32>
BETTER_AUTH_URL=http://localhost:{{PORT}}
STRIPE_SECRET_KEY=sk_test_...    # Optional, for billing
STRIPE_PUBLIC_KEY=pk_test_...    # Optional, for billing
```

## ⚠️ Common Gotchas (for agents)

### 1. Database Adapter
Better Auth requires a **driver instance**, NOT a URL string:
```typescript
// ✅ CORRECT — SQLite
import Database from "better-sqlite3";
database: new Database("./corral.db")

// ✅ CORRECT — PostgreSQL
import { Pool } from "pg";
database: new Pool({ connectionString: "..." })

// ❌ WRONG — This does NOT work
database: { url: "file:./corral.db", type: "sqlite" }
```

### 2. Next.js API Rewrites
If `next.config.js` has rewrites that proxy `/api/*` to a backend, auth will break.
**Fix:** Exclude `/api/auth` from rewrites:
```javascript
// next.config.js
async rewrites() {
  return {
    afterFiles: [{
      source: '/api/:path((?!auth).*)',  // excludes /api/auth/*
      destination: 'http://localhost:YOUR_BACKEND_PORT/api/:path*',
    }],
  }
}
```

### 3. Missing Packages
SQLite needs `better-sqlite3`, PostgreSQL needs `pg`, MySQL needs `mysql2`.
These are NOT bundled with better-auth.

### 4. Layout Must Be Client Component
If using `<CorralProvider>` in `layout.tsx`, add `"use client"` and move metadata to `<head>` tags.

### 5. basePath Convention
Auth routes are always at `/api/auth`. Both server (`basePath`) and client (`serverUrl`) must match.

### 6. Sign Out Requires Content-Type Header
`POST /api/auth/sign-out` returns HTTP 415 without `Content-Type: application/json`.
Always include it, even if the body is empty: `fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' } })`.

### 7. Next.js .env.local Placement
Next.js reads `.env.local` **from the app root**, not parent directories.
In monorepos where the Next.js app is in a subdirectory (e.g., `frontend/`), 
env vars in the parent `.env` **will NOT be read**. Place them in `frontend/.env.local`.

### 8. Route Handler Must Have try/catch
Better Auth can throw unhandled promise rejections that kill the Next.js dev server.
The generated route handler wraps GET/POST in try/catch — **do not simplify this**.

### 9. Large App Dev Server OOM
Apps with many modules (1000+) may get SIGKILL during dev compilation.
Set `NODE_OPTIONS="--max-old-space-size=2048"` or use `next build && next start` for stability.

### 10. SPA: Auth Server is Separate
For React/Vite apps, Better Auth runs as a **standalone Express server** (not in the browser).
You MUST start it separately: `npm run dev:auth` (or `npx tsx server/auth.ts`).
Configure Vite proxy to forward `/api/auth` to `localhost:3001` in dev.
In production, use nginx/Caddy to route `/api/auth` to the auth server.
The `CorralProvider` `serverUrl` should be `/api/auth` (proxied) in dev, or the full URL in production.

### 11. SPA: CORS + Credentials
The standalone auth server must allow CORS with `credentials: true` for cookies to work.
Set `CORS_ORIGIN=http://localhost:5173` (your Vite dev port) in `.env`.
In production, set it to your actual domain. Better Auth also needs `trustedOrigins` configured.

### 12. Database Tables Auto-Bootstrap
Corral creates all required tables on first server start (`CREATE TABLE IF NOT EXISTS`).
No manual migration step needed. If you see "no such table: user", the bootstrap didn't run —
check that `lib/corral.ts` is imported by the route handler.

## Billing Plans
Plans are defined in `corral.yaml` under `billing.plans`.
Each plan has: name, price, Stripe price ID, feature limits, meter allowances.

## Usage Meters
Meters track consumption (API calls, storage, etc.) in `corral.yaml` under `meters`.
Gate access with `checkUsage(userId, meter)` server-side.

## Nudges
UI messages triggered by usage thresholds, trial expiry, etc. in `corral.yaml` under `nudges`.

## Modifying Config
Edit `corral.yaml` directly. Run `corral config validate` to check.
Changes to plans require `corral stripe sync` to update Stripe.
