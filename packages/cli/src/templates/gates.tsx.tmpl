// {{APP_NAME}} â€” Auth & Plan Gates (generated by Corral)
// Use these to protect pages and features based on auth state, plan, and features.
//
// <AuthGate>                  â€” requires login
// <PlanGate plan="pro">       â€” requires specific plan (admins bypass)
// <FeatureGate feature="x">   â€” requires feature allow-list from corral.yaml (admins bypass)
// <BlurGate plan="pro">       â€” shows blurred content with upgrade overlay

import React from "react";
import { useAuth } from "./auth-context";

const PLAN_RANK: Record<string, number> = { free: 0, pro: 1, team: 2, enterprise: 3 };

type GateUser = {
  plan?: string;
  role?: string;
};

function isAdmin(user: GateUser | null | undefined): boolean {
  return (user?.role || "") === "admin";
}

function hasPlan(userPlan: string | undefined, requiredPlan: string): boolean {
  const userRank = PLAN_RANK[userPlan || "free"] ?? 0;
  const requiredRank = PLAN_RANK[requiredPlan] ?? 1;
  return userRank >= requiredRank;
}

// AuthGate: blocks content unless authenticated.
export function AuthGate({ children, fallback }: { children: React.ReactNode; fallback?: React.ReactNode }) {
  const { user, loading } = useAuth();
  if (loading) return <div style={{ textAlign: "center", padding: "2rem", color: "#888" }}>Loading...</div>;
  if (!user) return <>{fallback || <AuthFallback />}</>;
  return <>{children}</>;
}

// PlanGate: requires specific plan or better. Admins always pass.
export function PlanGate({
  plan,
  children,
  fallback,
}: {
  plan: string;
  children: React.ReactNode;
  fallback?: React.ReactNode;
}) {
  const { user, loading } = useAuth();
  if (loading) return <div style={{ textAlign: "center", padding: "2rem", color: "#888" }}>Loading...</div>;
  if (!user) return <AuthFallback />;
  if (isAdmin(user as GateUser)) return <>{children}</>;

  if (!hasPlan((user as GateUser).plan, plan)) {
    return <>{fallback || <PlanFallback required={plan} current={(user as GateUser).plan || "free"} />}</>;
  }
  return <>{children}</>;
}

// FeatureGate: requires a named feature from current user's feature list.
// Assumes auth context returns user.features?: string[] (or callers pass fallback).
export function FeatureGate({
  feature,
  children,
  fallback,
}: {
  feature: string;
  children: React.ReactNode;
  fallback?: React.ReactNode;
}) {
  const { user, loading } = useAuth();
  if (loading) return <div style={{ textAlign: "center", padding: "2rem", color: "#888" }}>Loading...</div>;
  if (!user) return <AuthFallback />;
  if (isAdmin(user as GateUser)) return <>{children}</>;

  const features = ((user as any).features || []) as string[];
  if (!features.includes(feature)) {
    return <>{fallback || <FeatureFallback feature={feature} />}</>;
  }
  return <>{children}</>;
}

// BlurGate: shows content but blurs it when plan isn't met. Admins bypass.
export function BlurGate({ plan, children }: { plan: string; children: React.ReactNode }) {
  const { user } = useAuth();
  const locked = !user || (!isAdmin(user as GateUser) && !hasPlan((user as GateUser).plan, plan));

  return (
    <div style={{ position: "relative" }}>
      <div style={locked ? { filter: "blur(8px)", pointerEvents: "none", userSelect: "none" } : {}}>{children}</div>
      {locked && (
        <div
          style={{
            position: "absolute",
            inset: 0,
            display: "flex",
            alignItems: "center",
            justifyContent: "center",
            background: "rgba(0,0,0,0.4)",
            borderRadius: "12px",
          }}
        >
          <div style={{ textAlign: "center", padding: "2rem" }}>
            <h3>ðŸ”’ {plan.charAt(0).toUpperCase() + plan.slice(1)} Feature</h3>
            <p>Upgrade to {plan} to unlock this content.</p>
          </div>
        </div>
      )}
    </div>
  );
}

function AuthFallback() {
  return (
    <div style={{ textAlign: "center", padding: "3rem 2rem" }}>
      <h2>Sign in to continue</h2>
      <p style={{ color: "#888", margin: "0.5rem 0 1.5rem" }}>Create a free account to access this feature.</p>
    </div>
  );
}

function PlanFallback({ required, current }: { required: string; current: string }) {
  return (
    <div style={{ textAlign: "center", padding: "3rem 2rem" }}>
      <h2>ðŸ”’ {required.charAt(0).toUpperCase() + required.slice(1)} Plan Required</h2>
      <p style={{ color: "#888", margin: "0.5rem 0 1.5rem" }}>
        You're on the <strong>{current}</strong> plan. Upgrade to <strong>{required}</strong> to unlock this.
      </p>
    </div>
  );
}

function FeatureFallback({ feature }: { feature: string }) {
  return (
    <div style={{ textAlign: "center", padding: "3rem 2rem" }}>
      <h2>ðŸ”’ Feature Locked</h2>
      <p style={{ color: "#888", margin: "0.5rem 0 1.5rem" }}>
        Your current plan does not include <strong>{feature}</strong>.
      </p>
    </div>
  );
}
