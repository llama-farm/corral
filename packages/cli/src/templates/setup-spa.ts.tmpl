// {{APP_NAME}} â€” Corral Auth Setup (Standalone Server for SPA)
// This runs on your auth SERVER, not in the browser.
// The React app connects via fetch to this server's /api/auth/* endpoints.

import { betterAuth } from "better-auth";
import { admin } from "better-auth/plugins";
import Database from "better-sqlite3";
import path from "path";

const dbPath = path.resolve(process.cwd(), "corral.db");
const corsOrigin = process.env.CORS_ORIGIN || "http://localhost:5173";

// LEARNING #2: Auto-bootstrap tables on first run.
// Better Auth CLI hangs â€” never depend on it. Raw SQL is reliable.
function bootstrapDatabase(filePath: string) {
  const db = new Database(filePath);
  db.pragma("journal_mode = WAL");

  db.exec(`
    CREATE TABLE IF NOT EXISTS "user" (
      id TEXT PRIMARY KEY,
      name TEXT NOT NULL,
      email TEXT NOT NULL UNIQUE,
      emailVerified INTEGER NOT NULL DEFAULT 0,
      image TEXT,
      plan TEXT NOT NULL DEFAULT 'free',
      createdAt TEXT NOT NULL DEFAULT (datetime('now')),
      updatedAt TEXT NOT NULL DEFAULT (datetime('now')),
      role TEXT DEFAULT 'user',
      banned INTEGER DEFAULT 0,
      banReason TEXT,
      banExpires TEXT
    );
    CREATE TABLE IF NOT EXISTS "session" (
      id TEXT PRIMARY KEY,
      userId TEXT NOT NULL REFERENCES "user"(id) ON DELETE CASCADE,
      token TEXT NOT NULL UNIQUE,
      expiresAt TEXT NOT NULL,
      ipAddress TEXT,
      userAgent TEXT,
      createdAt TEXT NOT NULL DEFAULT (datetime('now')),
      updatedAt TEXT NOT NULL DEFAULT (datetime('now'))
    );
    CREATE TABLE IF NOT EXISTS "account" (
      id TEXT PRIMARY KEY,
      userId TEXT NOT NULL REFERENCES "user"(id) ON DELETE CASCADE,
      accountId TEXT NOT NULL,
      providerId TEXT NOT NULL,
      accessToken TEXT,
      refreshToken TEXT,
      accessTokenExpiresAt TEXT,
      refreshTokenExpiresAt TEXT,
      scope TEXT,
      password TEXT,
      createdAt TEXT NOT NULL DEFAULT (datetime('now')),
      updatedAt TEXT NOT NULL DEFAULT (datetime('now'))
    );
    CREATE TABLE IF NOT EXISTS "verification" (
      id TEXT PRIMARY KEY,
      identifier TEXT NOT NULL,
      value TEXT NOT NULL,
      expiresAt TEXT NOT NULL,
      createdAt TEXT NOT NULL DEFAULT (datetime('now')),
      updatedAt TEXT NOT NULL DEFAULT (datetime('now'))
    );
    CREATE TABLE IF NOT EXISTS "subscription" (
      id TEXT PRIMARY KEY,
      plan TEXT NOT NULL DEFAULT 'free',
      referenceId TEXT NOT NULL,
      stripeCustomerId TEXT,
      stripeSubscriptionId TEXT,
      status TEXT,
      periodStart TEXT,
      periodEnd TEXT,
      cancelAtPeriodEnd INTEGER DEFAULT 0,
      seats INTEGER DEFAULT 1
    );
    CREATE INDEX IF NOT EXISTS idx_session_token ON "session"(token);
    CREATE INDEX IF NOT EXISTS idx_session_userId ON "session"(userId);
    CREATE INDEX IF NOT EXISTS idx_account_userId ON "account"(userId);
    CREATE INDEX IF NOT EXISTS idx_user_email ON "user"(email);
  `);

  return db;
}

const db = bootstrapDatabase(dbPath);

// â”€â”€â”€ Auto-seed admin user on first run â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Reads from corral.yaml seed config, then falls back to env vars.
async function seedAdminIfNeeded() {
  let adminEmail = process.env.SEED_ADMIN_EMAIL || process.env.ADMIN_EMAIL || "";
  let adminPassword = process.env.SEED_ADMIN_PASSWORD || process.env.ADMIN_PASSWORD || "";
  let adminName = "Admin";
  let adminPlan = "{{DEFAULT_PAID_PLAN}}" || "free";

  // Try reading from corral.yaml
  const fs = await import("fs");
  const yamlPaths = ["corral.yaml", "../corral.yaml", "../frontend/corral.yaml"];
  for (const p of yamlPaths) {
    const resolved = path.resolve(process.cwd(), p);
    if (fs.existsSync(resolved)) {
      const content = fs.readFileSync(resolved, "utf-8");
      const emailMatch = content.match(/seed:\s*\n\s+admin:\s*\n[\s\S]*?email:\s*(\S+)/);
      const passMatch = content.match(/seed:\s*\n\s+admin:\s*\n[\s\S]*?password:\s*(\S+)/);
      const nameMatch = content.match(/seed:\s*\n\s+admin:\s*\n[\s\S]*?name:\s*(.+)/);
      if (emailMatch && !adminEmail) adminEmail = emailMatch[1];
      if (passMatch && !adminPassword) adminPassword = passMatch[1];
      if (nameMatch) adminName = nameMatch[1].trim();
      break;
    }
  }

  if (!adminEmail || !adminPassword) return;

  const existing = db.prepare(`SELECT id FROM "user" WHERE role = 'admin' LIMIT 1`).get();
  if (existing) return;

  // Use better-auth's API to create the user so password is properly hashed
  try {
    const { createHash } = await import("crypto");
    const bcrypt = await import("bcryptjs").catch(() => null);
    const hashedPw = bcrypt
      ? await bcrypt.default.hash(adminPassword, 12)
      : createHash("sha256").update(adminPassword).digest("hex");

    const id = Math.random().toString(36).slice(2) + Date.now().toString(36);
    const now = new Date().toISOString();
    const accountId = Math.random().toString(36).slice(2);

    db.prepare(`INSERT INTO "user" (id, name, email, emailVerified, plan, role, createdAt, updatedAt)
      VALUES (?, ?, ?, 1, ?, 'admin', ?, ?)`).run(id, adminName, adminEmail, adminPlan, now, now);
    db.prepare(`INSERT INTO "account" (id, userId, accountId, providerId, password, createdAt, updatedAt)
      VALUES (?, ?, ?, 'credential', ?, ?, ?)`).run(accountId, id, accountId, hashedPw, now, now);

    console.log(`ðŸ¤  Corral: Seeded admin â†’ ${adminEmail} (role=admin, plan=${adminPlan})`);
  } catch (e: any) {
    console.warn(`ðŸ¤  Corral: Could not seed admin user: ${e.message}`);
  }
}

seedAdminIfNeeded().catch(() => {});

// â”€â”€â”€ Detect frontend port from env for CORS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const frontendPort = process.env.FRONTEND_PORT || process.env.CLIENT_PORT || "5173";
const frontendOrigin = process.env.CORS_ORIGIN || `http://localhost:${frontendPort}`;

export const auth = betterAuth({
  // LEARNING #1: Pass the raw Database instance directly.
  // Do NOT use { db, type: "sqlite" } â€” causes "selectFrom is not a function".
  database: db,
  baseURL: process.env.BETTER_AUTH_URL || "http://localhost:{{PORT}}",
  basePath: "/api/auth",
  secret: process.env.BETTER_AUTH_SECRET,
  emailAndPassword: { enabled: true },
  plugins: [admin()],
  session: { expiresIn: 60 * 60 * 24 * 30 },
  user: {
    additionalFields: {
      plan: {
        type: "string" as const,
        defaultValue: "free",
      },
    },
  },
  // LEARNING #5: trustedOrigins is required for sign-out and CSRF protection.
  // Include both localhost and 127.0.0.1 variants â€” browsers may send either.
  trustedOrigins: [
    frontendOrigin,
    frontendOrigin.replace("localhost", "127.0.0.1"),
    process.env.APP_URL,
  ].filter(Boolean) as string[],
});

export type Session = typeof auth.$Infer.Session;
