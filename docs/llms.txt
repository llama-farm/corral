# Corral â€” Agent-Native Auth + Payments

> Corral adds authentication, Stripe billing, and feature gating to any app via a single YAML config and CLI.
> You (the AI agent) can set up complete auth + payments for a project using just the CLI commands below.
> No manual wiring required. Read this file, run the commands, done.
>
> Designed for: OpenClaw, Claude Code, Codex, Cursor, and any AI coding assistant.
>
> Open-source SDK. Embedded in your app (not a hosted service). MIT license.
> Built on Better Auth + Stripe.
> GitHub: https://github.com/llama-farm/corral
> npm: https://www.npmjs.com/package/create-corral
> Docs: https://docs.llamafarm.dev/corral/
> Version: 0.1.0

## Quick Start (for agents)

> 1. Run: `npx create-corral init` (in the project directory)
> 2. Edit `corral.yaml` with the user's desired plans, features, and auth providers
> 3. Run: `npx create-corral doctor`
> That's it. The app now has auth + payments.

Full 9-command workflow (use this for complete setup):

```bash
npx create-corral analyze --json              # 1. detect framework/database (read-only)
npx create-corral init                        # 2. scaffold all files + install deps
npx create-corral add provider google         # 3. add OAuth provider
npx create-corral add plan pro --price 29 --trial 14  # 4. add paid plan
npx create-corral add feature ai_tools --plan pro     # 5. gate a feature to a plan
npx create-corral add meter api_calls --free 500 --pro 10000 --team 50000  # 6. usage meter
npx create-corral add page dashboard/analytics --gated pro  # 7. gated page
npx create-corral add device-verify           # 8. CLI auth page
npx create-corral doctor                      # 9. verify everything
```

All commands use `npx create-corral <command>`. All accept `--json` for structured output.

## What Corral Is

Corral is a library that adds auth, billing, and feature gating to any Node.js app
from a single YAML config file (`corral.yaml`). It mounts as route handlers inside
your existing app â€” no Docker, no separate service, no per-MAU pricing.

Key properties (important for agents):
- One config file (`corral.yaml`) defines everything â€” edit YAML, not code
- Shares your app's existing database (SQLite default, PostgreSQL/MySQL/Turso supported)
- Mounts at `/api/auth` in your app
- Every CLI command has `--json` output for structured agent parsing
- Generates `CORRAL.md` (project-specific agent guide) on init
- All `corral add` commands are idempotent â€” safe to run twice
- Exit code 0 = success, 1 = error with details

## corral.yaml Structure

```yaml
app:
  name: MyApp
  id: myapp
  domain: http://localhost:3000

auth:
  methods:
    email_password: true
    google: true
    github: true
  session:
    max_age: 2592000

plans:
  - name: free
    price: 0
    features: [basic_access]
  - name: pro
    price: 29
    interval: month
    trial_days: 14
    features: [ai_tools, analytics, export]
  - name: team
    price: 99
    interval: month
    features: [ai_tools, analytics, export, team_sharing]

features:
  basic_access: ["*"]           # everyone including anonymous
  ai_tools: [pro, team]        # pro and team plans
  team_sharing: [team]          # team plan only

meters:
  api_calls:
    limits:
      free: 500
      pro: 10000
      team: 50000
    warning_at: 0.8

billing:
  provider: stripe
  cancel_behavior: end_of_period

database:
  adapter: sqlite
  url: file:./corral.db
```

## CLI Commands

All commands accept `--json` and `--help`. Use `npx create-corral <command>`.

### Setup
- `analyze [--json]`                     â€” detect project framework/database (read-only)
- `init [--db sqlite|pg|mysql|turso|d1]` â€” scaffold Corral into project, install deps
- `doctor`                               â€” deep health check (config + env + deps)
- `validate [--json]`                    â€” runtime validation (hits endpoints)
- `status [--json]`                      â€” show users, plans, MRR, Stripe status

### Add capabilities (all idempotent)
- `add page <path> [--gated <plan>]`     â€” create a page (--gate also works)
- `add feature <name> --plan <plan>`     â€” gate a feature to plan(s) (comma-separated)
- `add meter <name> --limit <n> --plan <p>` â€” add usage meter for one plan
- `add meter <name> --free <n> --pro <n> --team <n>` â€” set all plan limits at once
- `add provider <name>`                  â€” add OAuth provider (google, github, etc.)
- `add plan <name> --price <n> [--trial <days>] [--features <list>]`
- `add webhook`                          â€” generate Stripe webhook handler
- `add device-verify`                    â€” generate CLI device auth page
- `add admin-page`                       â€” generate admin dashboard page

### Stripe
- `stripe push [--json]`                â€” sync corral.yaml plans to Stripe products/prices

### Development
- `seed`                                 â€” seed database with test users
- `dev`                                  â€” start standalone auth dev server
- `rollback [--list]`                    â€” undo last init/add operation
- `llms-txt [--output <path>] [--full]`  â€” generate llms.txt from config

## Auth Providers

Supported: google, github, discord, apple, microsoft, twitter, facebook,
           gitlab, linkedin, email (password + magic_link + otp)

Device auth: CLI-to-browser OAuth2 device flow.
CLI prints code â†’ user approves in browser â†’ CLI gets long-lived token.

## HTTP API

Base: `/api/auth` (Better Auth) and `/api/corral` (billing/device/usage)

### Auth (Better Auth endpoints)
- `POST /api/auth/sign-up/email` â€” `{ email, password, name }`
- `POST /api/auth/sign-in/email` â€” `{ email, password }`
- `POST /api/auth/sign-out`
- `GET  /api/auth/get-session` â€” returns user + session (requires cookie or Bearer token)
- `GET  /api/auth/sign-in/social?provider=google&callbackURL=/`

### Billing
- `POST /api/corral/checkout` â€” `{ planId }` â†’ `{ url }` (Stripe checkout URL)
- `GET  /api/corral/billing` â€” subscription + invoices
- `POST /api/corral/cancel` â€” cancel at period end
- `POST /api/corral/reactivate` â€” undo cancel
- `GET  /api/corral/subscription/status` â€” `{ plan, role }` (for CLI polling)

### Device Auth (for CLI tools)
- `POST /api/corral/device/authorize` â†’ `{ deviceCode, userCode, verificationUrl }`
- `POST /api/corral/device/token` `{ deviceCode }` â†’ `{ accessToken, refreshToken }` (poll until approved)
- `POST /api/corral/device/verify` `{ userCode, action: "approve" }` (browser calls this)
- `POST /api/corral/device/refresh` `{ refreshToken }` â†’ new tokens (rotation)

### API Keys
- `POST   /api/corral/apikeys` `{ name }` â†’ `{ id, key, prefix }` (key shown once)
- `GET    /api/corral/apikeys` â†’ list (prefix only)
- `DELETE /api/corral/apikeys/:id` â€” revoke

### Usage Meters
- `POST /api/corral/usage/track` `{ meterId, count }` â€” increment
- `GET  /api/corral/usage/:meterId` â†’ `{ used, limit, remaining, resetAt }`
- `GET  /api/corral/usage` â€” all meters for current user

### Admin (requires role: admin)
- `GET /api/auth/admin/list-users` â€” paginated user list

## Files Generated by `corral init`

For Next.js (app router):
```
corral.yaml                              â€” main config (edit this)
CORRAL.md                                â€” agent guide (auto-generated)
lib/corral.ts                            â€” Better Auth setup + DB bootstrap
app/api/auth/[...all]/route.ts           â€” auth route handler
.env.local                               â€” BETTER_AUTH_SECRET + URL
```

Additional files from `corral add`:
```
app/api/webhooks/stripe/route.ts         â€” from: corral add webhook
app/device/verify/page.tsx               â€” from: corral add device-verify
app/<path>/page.tsx                      â€” from: corral add page <path>
```

## Environment Variables

Required (set in .env.local):
  `BETTER_AUTH_SECRET`   â€” random string for session signing (auto-generated by init)
  `BETTER_AUTH_URL`      â€” app URL (default: http://localhost:3000)

Billing (if using Stripe):
  `STRIPE_SECRET_KEY`    â€” sk_test_... or sk_live_...
  `STRIPE_PUBLISHABLE_KEY` â€” pk_test_... or pk_live_...
  `STRIPE_WEBHOOK_SECRET` â€” whsec_...

Auth providers (per provider):
  `GOOGLE_CLIENT_ID`, `GOOGLE_CLIENT_SECRET`
  `GITHUB_CLIENT_ID`, `GITHUB_CLIENT_SECRET`

## Databases Supported

sqlite (default), postgresql, mysql, turso/libsql, cloudflare-d1
Use `corral init --db <type>` to select.

## Multi-Language Backend Validation

Non-Node backends can validate Corral sessions by reading the shared database:
- Python: `corral/validation/python/` â€” FastAPI/Flask/Django middleware
- Go: `corral/validation/go/` â€” stdlib middleware
- Rust: `corral/validation/rust/` â€” Axum extractor
- Ruby: `corral/validation/ruby/` â€” Rack middleware

These read the `session` + `user` tables. All auth operations go through the Node server.

## More

- Full docs: https://docs.llamafarm.dev/corral/
- GitHub: https://github.com/llama-farm/corral
- npm: https://www.npmjs.com/package/create-corral
- License: MIT
- Built by LlamaFarm ðŸ¦™
